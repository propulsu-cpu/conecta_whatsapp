<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Conector WhatsApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  </style>
</head>
<body class="bg-gray-100">
  <main class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-xl shadow-2xl p-8">
      <header class="text-center mb-6">
        <img src="https://iyup.com.br/wp-content/uploads/2024/10/logo-iyup-chat-novo.svg" alt="iYupChat" class="h-8 mx-auto mb-2" />
        <p class="text-sm text-gray-600">Conecte seu WhatsApp ao painel</p>
      </header>

      <!-- Form -->
      <div id="connection-form" class="space-y-4">
        <label for="instance" class="block text-sm font-medium text-gray-700">Nome da Instância</label>
        <input id="instance" type="text" placeholder="minha-instancia-whatsapp"
               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-600 focus:border-transparent" />
        <button id="generate-qr"
                class="w-full bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white font-medium py-3 rounded-lg transition">
          Gerar QR Code
        </button>
      </div>

      <!-- QR -->
      <div id="qr-display" class="hidden mt-8">
        <div class="rounded-xl border border-gray-100 shadow">
          <div class="p-6 text-center">
            <div id="qrcode" class="w-48 h-48 mx-auto bg-white rounded-xl flex items-center justify-center">
              <!-- Spinner oculto por padrão -->
              <div id="loading-spinner" class="hidden">
                <svg class="animate-spin h-10 w-10 text-purple-600" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                  <path d="M4 12a8 8 0 018-8" fill="currentColor" class="opacity-75"></path>
                </svg>
              </div>
              <canvas id="qrcodeCanvas" style="display:none;background:#ffffff;border-radius:0.75rem;"></canvas>
            </div>
            <div id="countdown" class="text-sm text-gray-600 mt-3">Atualizando em: <span>30s</span></div>
          </div>
          <div id="connection-status" class="px-6 py-3 bg-gray-50 border-t text-center text-xs text-gray-600">
            <svg class="w-4 h-4 mr-1 inline animate-pulse" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.05 3.636a1 1 0 011.414 0 9 9 0 0112.728 12.728 1 1 0 11-1.414-1.414 7 7 0 00-9.9-9.9 1 1 0 01-1.414-1.414z" clip-rule="evenodd"/>
            </svg>
            Aguardando conexão...
          </div>
        </div>
      </div>

      <!-- Status suc/erro -->
      <div id="status-display" class="hidden mt-6"></div>
      <div id="error-display" class="hidden mt-6"></div>

      <!-- Ações perfil -->
      <div id="profile-actions" class="hidden mt-6 flex justify-center gap-3">
        <button onclick="restartInstance()" class="text-xs px-3 py-1 rounded bg-yellow-100 text-yellow-800">Reiniciar</button>
        <button onclick="logoutInstance()" class="text-xs px-3 py-1 rounded bg-red-100 text-red-700">Desconectar</button>
        <button onclick="updateProfileInfo()" class="text-xs px-3 py-1 rounded bg-blue-100 text-blue-700">Atualizar</button>
        <button onclick="showEditProfileModal()" class="text-xs px-3 py-1 rounded bg-purple-100 text-purple-700">Editar</button>
      </div>

      <!-- Perfil -->
      <div id="profile-info" class="hidden mt-6"></div>

      <!-- Logs -->
      <div class="mt-8">
        <button id="toggle-logs" class="w-full text-sm text-gray-600 hover:text-gray-800 flex items-center justify-center gap-2">
          <svg id="logs-icon-closed" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          <svg id="logs-icon-open" class="w-4 h-4 hidden rotate-180" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          Logs do sistema <span id="logs-count" class="ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-gray-100 text-gray-700">0</span>
        </button>
        <div id="logs" class="hidden mt-2 bg-gray-50 rounded p-3 max-h-40 overflow-y-auto">
          <div class="space-y-1 text-xs font-mono"><div class="text-blue-600">[Sistema] Pronto.</div></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Tutorial (inicia oculto; exibido via JS se 1ª vez) -->
  <div id="tutorial-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-md mx-4">
      <h2 class="text-lg font-semibold mb-2">Como conectar</h2>
      <ol class="list-decimal ml-5 text-sm text-gray-700 space-y-1">
        <li>Clique em “Gerar QR Code”.</li>
        <li>No celular: WhatsApp → Aparelhos conectados → Parear.</li>
        <li>Aponte a câmera para o QR aqui da tela.</li>
      </ol>
      <button id="close-tutorial" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded">Entendi</button>
    </div>
  </div>

  <!-- Modal Editar Perfil -->
  <div id="edit-profile-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-md mx-4 w-full">
      <h2 class="text-lg font-semibold mb-4">Editar Perfil</h2>
      <form id="edit-profile-form" class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Nome</label>
          <input id="profile-name" class="w-full px-3 py-2 border rounded" placeholder="Seu nome" />
        </div>
        <div>
          <label class="block text-sm mb-1">Status</label>
          <input id="profile-status" class="w-full px-3 py-2 border rounded" placeholder="Seu status" />
        </div>
        <div>
          <label class="block text-sm mb-1">Foto</label>
          <input id="profile-picture" type="file" accept="image/*" class="w-full" />
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditProfileModal()" class="px-3 py-2 text-sm">Cancelar</button>
          <button class="px-3 py-2 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ====== CONFIGURE AQUI ====== */
    const BASE_URL = 'https://evolution.propulsu.com.br'; // TROQUE SE PRECISAR
    const API_KEY  = 'SUA_API_KEY_AQUI';                  // TROQUE PELA SUA
    /* ============================ */

    let countdownInterval = null;
    let statusInterval = null;

    // Util: logs
    function addLog(msg, type='info') {
      const wrap = document.querySelector('#logs .space-y-1');
      if (!wrap) return;
      const el = document.createElement('div');
      el.className = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      wrap.appendChild(el);
      const cnt = document.getElementById('logs-count');
      if (cnt) cnt.textContent = String((+cnt.textContent||0)+1);
      const cont = document.getElementById('logs');
      if (cont) cont.scrollTop = cont.scrollHeight;
    }

    // UI helpers
    function show(el){ el && el.classList.remove('hidden'); }
    function hide(el){ el && el.classList.add('hidden'); }

    // QR
    async function generateQRCode(instance) {
      const spinner = document.getElementById('loading-spinner');
      const canvas  = document.getElementById('qrcodeCanvas');
      const qrWrap  = document.getElementById('qr-display');
      show(qrWrap);
      hide(document.getElementById('error-display'));
      show(document.getElementById('status-display')); // será atualizado depois

      // limpa canvas / mostra spinner
      if (canvas) { const ctx = canvas.getContext('2d'); ctx && ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display='none'; }
      show(spinner);

      try {
        // se já está conectado, nem gera QR
        const statusRes = await fetch(`${BASE_URL}/instance/connectionState/${encodeURIComponent(instance)}`, {
          headers:{ apikey: API_KEY }
        });
        if (statusRes.ok) {
          const st = await statusRes.json();
          if (st?.instance?.state === 'open') {
            addLog('Instância já conectada', 'success');
            updateConnectionStatus('open');
            hide(qrWrap);
            await fetchInstanceInfo(instance);
            return true;
          }
        }

        const res = await fetch(`${BASE_URL}/instance/connect/${encodeURIComponent(instance)}`, {
          method:'GET', headers:{ apikey: API_KEY }
        });

        if (!res.ok) {
          if (res.status === 404) {
            showError('Instância não encontrada. Verifique o nome e tente novamente.');
            addLog('Instância não encontrada (404)', 'error');
            return false;
          }
          throw new Error(`Erro na conexão: ${res.status}`);
        }

        const data = await res.json();
        const code = data?.code || data?.qrcode || data?.qr || '';
        if (!code) {
          addLog('QR Code ainda não disponível', 'info');
          updateConnectionStatus('connecting');
          return false;
        }

        // Renderiza o QR no canvas (fundo branco para evitar “círculo preto”)
        await new Promise((resolve, reject) => {
          QRCode.toCanvas(canvas, code, {
            width: 192, height: 192, margin: 0,
            color: { dark: '#000000', light: '#ffffff' } // <— fundo branco
          }, (err) => err ? reject(err) : resolve());
        });

        addLog('QR Code gerado', 'success');
        spinner.classList.add('hidden');
        canvas.style.display = 'block';
        updateConnectionStatus('connecting');
        return true;
      } catch (e) {
        addLog(`Erro ao gerar QR: ${e.message}`, 'error');
        showError('Falha ao gerar o QR Code. Tente novamente.');
        return false;
      } finally {
        hide(spinner);
      }
    }

    function startCountdown(instance) {
      stopCountdown();
      const span = document.querySelector('#countdown span');
      if (!span) return;
      let t = 30; span.textContent = `${t}s`;
      countdownInterval = setInterval(async () => {
        t--; span.textContent = `${t}s`;
        if (t <= 0) {
          clearInterval(countdownInterval);
          await generateQRCode(instance);
          startCountdown(instance);
        }
      }, 1000);
    }
    function stopCountdown(){ if (countdownInterval) { clearInterval(countdownInterval); countdownInterval=null; } }

    // Status
    function updateConnectionStatus(state) {
      const cs = document.getElementById('connection-status');
      const sd = document.getElementById('status-display');
      if (!cs || !sd) return;

      if (state === 'open') {
        cs.innerHTML = `
          <div class="flex items-center justify-center text-xs text-gray-600">
            <svg class="w-4 h-4 mr-1 text-green-600" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
            Conectado
          </div>`;
        sd.classList.remove('hidden');
        sd.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
            <p class="text-green-700 text-sm font-medium">WhatsApp conectado</p>
          </div>`;
      } else {
        cs.innerHTML = `
          <div class="flex items-center justify-center text-xs text-gray-600">
            <svg class="w-4 h-4 mr-1 animate-pulse" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.05 3.636a1 1 0 011.414 0 9 9 0 0112.728 12.728 1 1 0 11-1.414-1.414 7 7 0 00-9.9-9.9 1 1 0 01-1.414-1.414z" clip-rule="evenodd"/></svg>
            Aguardando conexão...
          </div>`;
        sd.classList.remove('hidden');
        sd.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
            <p class="text-red-700 text-sm font-medium">WhatsApp desconectado</p>
          </div>`;
      }
    }

    async function checkConnectionStatus(instance) {
      if (statusInterval) clearInterval(statusInterval);
      const qrBox = document.getElementById('qr-display');
      const actions = document.getElementById('profile-actions');

      const tick = async () => {
        try {
          const r = await fetch(`${BASE_URL}/instance/connectionState/${encodeURIComponent(instance)}`, {
            headers:{ apikey: API_KEY }
          });
          if (!r.ok) return;
          const d = await r.json();
          const state = d?.instance?.state || 'close';

          if (state === 'open') {
            updateConnectionStatus('open');
            hide(qrBox);
            show(actions);
            await fetchInstanceInfo(instance);
            stopCountdown();
          } else {
            updateConnectionStatus('connecting');
            show(qrBox);
            hide(document.getElementById('profile-info'));
            hide(actions);
          }
        } catch {}
      };

      await tick();
      statusInterval = setInterval(tick, 3000);
    }

    // Perfil
    async function fetchInstanceInfo(instance) {
      try {
        const res = await fetch(`${BASE_URL}/instance/fetchInstances?instanceName=${encodeURIComponent(instance)}`, {
          headers:{ apikey: API_KEY }
        });
        if (!res.ok) return;

        const arr = await res.json();
        const info = Array.isArray(arr) && arr[0] ? arr[0] : null;
        const box = document.getElementById('profile-info');
        if (!box) return;

        if (!info || info.connectionStatus !== 'open') {
          hide(box);
          return;
        }

        const chats = info?._count?.Chat ?? 0;
        const contacts = info?._count?.Contact ?? 0;
        const msgs = info?._count?.Message ?? 0;

        box.innerHTML = `
          <div class="bg-white rounded-lg p-4 shadow">
            <div class="flex items-center gap-3">
              <img class="h-12 w-12 rounded-full object-cover" src="${info.profilePicUrl || 'https://via.placeholder.com/48'}" alt="">
              <div class="min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate">${info.profileName || 'Nome não disponível'}</p>
                <p class="text-xs text-gray-600 truncate">${info.number || info.ownerJid || 'Número não disponível'}</p>
              </div>
              <span class="ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs bg-green-100 text-green-800">Conectado</span>
            </div>
            <div class="grid grid-cols-3 gap-4 mt-4 pt-3 border-t">
              <div class="text-center">
                <p class="text-lg font-semibold text-gray-900">${Number(chats).toLocaleString()}</p>
                <p class="text-xs text-gray-500">Conversas</p>
              </div>
              <div class="text-center">
                <p class="text-lg font-semibold text-gray-900">${Number(contacts).toLocaleString()}</p>
                <p class="text-xs text-gray-500">Contatos</p>
              </div>
              <div class="text-center">
                <p class="text-lg font-semibold text-gray-900">${Number(msgs).toLocaleString()}</p>
                <p class="text-xs text-gray-500">Mensagens</p>
              </div>
            </div>
          </div>`;
        show(box);
      } catch (e) {
        addLog(`Erro ao buscar perfil: ${e.message}`, 'error');
      }
    }

    // Reiniciar / Logout / Atualização de perfil
    async function restartInstance() {
      const instance = document.getElementById('instance').value.trim();
      if (!instance) return;
      try {
        addLog('Reiniciando instância...', 'info');
        const a = await fetch(`${BASE_URL}/instance/logout/${encodeURIComponent(instance)}`, { method:'DELETE', headers:{ apikey: API_KEY } });
        if (!a.ok) throw new Error(`Logout ${a.status}`);
        await new Promise(r=>setTimeout(r,1500));
        const b = await fetch(`${BASE_URL}/instance/connect/${encodeURIComponent(instance)}`, { headers:{ apikey: API_KEY } });
        if (!b.ok) throw new Error(`Connect ${b.status}`);
        addLog('Instância reiniciada', 'success');
        show(document.getElementById('qr-display'));
        await generateQRCode(instance);
        startCountdown(instance);
        checkConnectionStatus(instance);
      } catch(e){ addLog(`Falha ao reiniciar: ${e.message}`,'error'); }
    }

    async function logoutInstance() {
      const instance = document.getElementById('instance').value.trim();
      if (!instance) return;
      try {
        addLog('Desconectando...', 'info');
        const r = await fetch(`${BASE_URL}/instance/logout/${encodeURIComponent(instance)}`, { method:'DELETE', headers:{ apikey: API_KEY } });
        if (!r.ok) throw new Error(`Logout ${r.status}`);
        addLog('Desconectado', 'success');
        show(document.getElementById('qr-display'));
        updateConnectionStatus('connecting');
        await generateQRCode(instance);
        startCountdown(instance);
        checkConnectionStatus(instance);
      } catch(e){ addLog(`Erro no logout: ${e.message}`,'error'); }
    }

    async function updateProfileInfo() {
      const instance = document.getElementById('instance').value.trim();
      if (!instance) return;
      try {
        addLog('Atualizando perfil...', 'info');
        const r = await fetch(`${BASE_URL}/instance/fetchProfile?instanceName=${encodeURIComponent(instance)}`, { headers:{ apikey: API_KEY } });
        if (!r.ok) throw new Error(`fetchProfile ${r.status}`);
        await r.json();
        await fetchInstanceInfo(instance);
        addLog('Perfil atualizado', 'success');
      } catch(e){ addLog(`Erro ao atualizar perfil: ${e.message}`,'error'); }
    }

    async function updateProfileName(name) {
      const instance = document.getElementById('instance').value.trim(); if (!instance || !name) return;
      try {
        const r = await fetch(`${BASE_URL}/instance/updateProfileName`, {
          method:'POST',
          headers:{ apikey: API_KEY, 'Content-Type':'application/json' },
          body: JSON.stringify({ instanceName: instance, name })
        });
        if (!r.ok) throw new Error(`updateProfileName ${r.status}`);
        addLog('Nome atualizado', 'success');
      } catch(e){ addLog(`Erro ao atualizar nome: ${e.message}`,'error'); }
    }
    async function updateProfileStatus(status) {
      const instance = document.getElementById('instance').value.trim(); if (!instance || !status) return;
      try {
        const r = await fetch(`${BASE_URL}/instance/updateProfileStatus`, {
          method:'POST',
          headers:{ apikey: API_KEY, 'Content-Type':'application/json' },
          body: JSON.stringify({ instanceName: instance, status })
        });
        if (!r.ok) throw new Error(`updateProfileStatus ${r.status}`);
        addLog('Status atualizado', 'success');
      } catch(e){ addLog(`Erro ao atualizar status: ${e.message}`,'error'); }
    }
    async function updateProfilePicture(file) {
      const instance = document.getElementById('instance').value.trim(); if (!instance || !file) return;
      try {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64 = String(e.target.result).split(',')[1] || '';
          const r = await fetch(`${BASE_URL}/instance/updateProfilePicture`, {
            method:'POST',
            headers:{ apikey: API_KEY, 'Content-Type':'application/json' },
            body: JSON.stringify
